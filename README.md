# Distributed systems

# Документация на API за Блог система

## Общ преглед

Документация на REST API за блог система, разработена с Next.js, Sanity.io и Supabase.

## Архитектура на системата

Системата използва хибридна архитектура, комбинираща няколко специализирани услуги:

### Sanity.io CMS

Sanity се използва като headless CMS за управление на съдържанието на блога поради следните предимства:

- **Структурирано съдържание**: Позволява дефиниране на схеми за различни типове съдържание (публикации, автори, категории)
- **Гъвкаво управление**: Предоставя удобен редактор за създаване и редактиране на съдържание. Това е много удобно за защото блога ще се използва от ученици по журналистика в Софийския университет и те лесно могат да работят върху съдържанието си.
- **Real-time API**: Осигурява моментален достъп до съдържанието чрез GROQ заявки
- **Версиониране**: Поддържа история на промените в съдържанието
- **Медия управление**: Интегрирана система за управление на изображения с автоматично преоразмеряване

Системата синхронизира данните от Sanity с локалната база данни (Supabase) чрез webhook за автоматично актуализиране при промени в съдържанието.

### Supabase

Supabase се използва като база данни и система за автентикация поради:

- **PostgreSQL база данни**: Пълнофункционална релационна база данни с отворен код
- **Authentication**: Готови решения за регистрация, вход и управление на потребители
- **JavaScript/TypeScript SDK**: Улеснява интеграцията с Next.js приложения

Supabase се използва за съхранение на потребителски данни, коментари, харесвания и други интерактивни елементи, докато основното съдържание на публикациите се управлява от Sanity.

## Структура на база данни

![Untitled.svg](Untitled.svg)

## Интеграция между Sanity и Supabase

Системата използва двупосочна синхронизация между Sanity и Supabase:

1. **Sanity към Supabase**:
   - Webhook от Sanity известява API-то за промени в съдържанието
   - Системата извлича актуализираните данни и ги записва в Supabase
   - Това поддържа метаданни като харесвания и коментари, свързани с актуалното съдържание
2. **Supabase към Frontend**:
   - Next.js приложението използва Supabase клиент за достъп до данните
   - Потребителските взаимодействия се записват директно в Supabase
   - Realtime функционалността на Supabase позволява актуализации в реално време

## API Endpoints

### Публично съдържание

### Извличане на всички публикации

```
GET /posts

```

**Параметри:** limit, page, category

**Връща:** Списък с публикации (id, заглавие, slug, дата, изображение, автор)

### Извличане на публикация по slug

```
GET /posts/{slug}

```

**Връща:** Детайлна информация за публикацията

### Извличане на коментари по публикация

```
GET /posts/{postId}/comments

```

**Параметри:** limit, page

**Връща:** Списък с коментари

### Потребители

### Регистрация на потребител

```
POST /auth/register

```

**Приема:** email, password, name

**Връща:** Информация за създадения потребител и токен

### Вход в системата

```
POST /auth/login

```

**Приема:** email, password

**Връща:** Информация за потребителя и токен

### Обновяване на потребителски профил

```
PUT /users/profile

```

**Приема:** name, bio, website, social_links

**Връща:** Обновена информация за профила

### Извличане на профил на потребител

```
GET /users/{userId}/profile

```

**Връща:** Публична профилна информация

### Взаимодействия

### Добавяне на коментар

```
POST /posts/{postId}/comments

```

**Приема:** content, parent_id (опционално)

**Връща:** Създаденият коментар

### Харесване на публикация

```
POST /posts/{postId}/like

```

**Връща:** Статус на харесване и брой харесвания

### Следване на потребител

```
POST /users/{userId}/follow

```

**Връща:** Статус на следване

### Администраторски функции

### Създаване на категория

```
POST /admin/categories

```

**Приема:** name, slug, description

**Връща:** Създадената категория

### Синхронизиране на публикации от Sanity

```
POST /admin/sync/posts

```

**Връща:** Информация за синхронизираните публикации

### Webhook Endpoints

```
POST /webhooks/sanity

```

**Приема:** Sanity webhook събития

**Връща:** Потвърждение за обработка

## Автентикация и сигурност

Системата използва JWT базирана автентикация, управлявана от Supabase Auth:

- **JWT токени**: Всеки метод изискваш authentication включва JWT токен в хедъра:
  ```
  Authorization: Bearer {token}

  ```
- **Роли и права**: Supabase Row Level Security (RLS) прилага правила за достъп на ниво бази данни
- **Защита от CSRF**: Имплементирани мерки срещу Cross-Site Request Forgery атаки
- **API Rate Limiting**: Ограничения на броя заявки за предотвратяване на злоупотреби

## Техническа имплементация

### Frontend

- **Next.js**: React framework за рендериране на страници от сървъра (SSR) и статично генериране (SSG). Избрах next.js защото работя като front-end dev изпозлвайки React и имам опит с него, както и заради важността на server-side rendering в блоговете за да максимализираме SEO-то.
- **TypeScript**: За типова безопасност и по-добро разработване
- **TailwindCSS**: За стилизиране на компоненти

### Backend

- **Next.js API Routes**: Сървърна имплементация на API endpoints
- **Sanity Client**: За извличане на съдържание от Sanity CMS
- **Supabase JS Client**: За достъп до Supabase база данни и автентикация
- **Vercel**: За хостинг и деплойване на приложението
